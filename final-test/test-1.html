<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
  <title>Scatterplot d3v4</title>
  <style type="text/css">
body{
      margin: 100;
      font-family: arial, sans;
    }

    .label{
      font-size: 15px;
    }
    img{
      width: 100px;
      height: 100px;
    }

    .legend text,
    .axis text {
      font-size: 13px;
      fill: #333;
    }

    .axis path,
    .axis line{
      fill: none;
      stroke-width: 1px;
      stroke: #777;
    }

    .legend rect{
      fill-opacity: 0.75;
    }

    .bubble :hover circle {
      fill: red;
    }
</style>
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>

<script type="text/javascript">

var margin = {top: 50, right: 50, bottom: 50, left: 50},
    width = 960 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom,

    padding = 2,
    maxRadius = 30,
    minRadius = 1,
    numberOfNodes = 144;


var x = d3.scaleLinear()
  .domain( [0, 100] )
  .range( [margin.left, width + margin.right ] );

var xAxis = d3.axisBottom(x);

var svg = d3.select("body").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .attr("shape-rendering", "geometric-precision");

var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

// svg.call(tip);

svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + ( margin.top + ( height/2) ) + ")");
  // .call(xAxis);

var xAxisTitle = svg.append("text")
  .attr("class", "axisTitle")
  .text("ranking")

xAxisTitle
  .attr("x", width - xAxisTitle.node().getBBox().width + margin.right)
  .attr("y", margin.top + ( height/2) - xAxisTitle.node().getBBox().height);

svg.append("text")
  .attr("x", 50)
  .attr("y", 30)
  .attr("dy", "0.71em")
  .text("numbers of artists");

d3.csv('music_2018.csv', function(error, data){
    data.forEach(function(d){
      d.ranking = +d.ranking;
      // d.year = +d.year;
      d.appearance = +d.appearance;
    });
    console.log(data);
  var nodes = data.map(function(node, index) {
    return {
      index: index,
      // name: node.name,
      ranking: node.ranking,
      x: x(node.ranking),
      fx: x(node.ranking),
    };
  });

  var sizeScale = d3.scaleLinear()
  .domain([d3.min(data, function(d){ return d.ranking;}), d3.max(data,  function(d){ return d.ranking;})])
  .range([minRadius,maxRadius]);

  // var colorScale = d3.scaleSequential(d3.interpolateRainbow)
  // .domain( [d3.min(data, function(d){ return d.value;}), d3.max(data,  function(d){ return d.value;})] );

  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + ( margin.top + ( height/2) ) + ")")
    // .call(xAxis);

  var simulation = d3.forceSimulation(nodes)
    .force("x", d3.forceX(function(d) { return x(d.ranking); }))
    .force("y", d3.forceY(250))
    .force("collide", d3.forceCollide().radius(10))
    .force("manyBody", d3.forceManyBody().strength(10))
    .stop();

    // set back
    

  for (var i = 0; i < 150; ++i) simulation.tick();

  var bubble = svg.selectAll(".bubble")
    .data(nodes)

    .enter().append("circle")
    .style("fill", 'white')
    .attr("cx", function(d) { return d.x} )
    .attr("cy", function(d) { return d.y} )
    .attr("r", 0 )
    .style("opacity", 0.6)
    .style("stroke", "black")
    .style('stroke-width', 2)

    bubble
    .transition()

    .duration(900)
    .attr("cx", function(d) { return d.x} )
    .attr("cy", function(d) { return d.y} )
    .attr('r', 5)
    .attr('fill-opacity', 0.8);

    bubble  
    .on("mouseover", function(d){
        tooltip.transition()
              .duration(200)
              .style('opacity',0.9);
        tooltip
              .html(d.name + " - " + d.artists + "<br/>" + "ranking:" + d.ranking
                +"<br/>" + "<img src='"+d.track_image+"'/>")
              .style("left", d3.select(this).attr("cx") + "px")
              .style("top", d3.select(this).attr("cy") + "px");      
    })

    .on("mouseout", function(d){
        tooltip.transition()
             .duration(500)
             .style("opacity", 0);
    });
    // .on('mouseover', tip.show)
    // .on('mouseout', tip.hide)
    svg.append('text')
      .attr('x', 10)
      .attr('y', 10)
      .attr('class', 'label');

    svg.append('text')
      .attr('x', width)
      .attr('y', height)
      .attr('text-anchor', 'end')
      .attr('class', 'label');

    var images = bubble.append("svg:image")
      .attr("xlink:href",  function(d) { return d.track_image;})
      .attr("x", function(d) { return -25;})
      .attr("y", function(d) { return -25;})
      .attr("height", 50)
      .attr("width", 50);
    var setEvents = images
      .on( 'mouseenter', function() {
        // select element in current context
        d3.select( this )
          .transition()
          .attr("x", function(d) { return -60;})
          .attr("y", function(d) { return -60;})
          .attr("height", 100)
          .attr("width", 100);
      })
      // set back
      .on( 'mouseleave', function() {
        d3.select( this )
          .transition()
          .attr("x", function(d) { return -25;})
          .attr("y", function(d) { return -25;})
          .attr("height", 50)
          .attr("width", 50);
      });
});
</script>

</body>
</html>